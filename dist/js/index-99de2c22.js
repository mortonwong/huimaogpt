import{b as De}from"./vue-router-6dcef795.js";import{s as Me}from"./pinia-7b1e1edf.js";import{h as Pe}from"./html2canvas-18c4afc9.js";import{u as de,i as Ne,d as ge,a as pe,t as h,_ as E,b as re,c as Ke,e as G,f as xe,s as Ze,g as qe,h as He,j as Ve,k as me}from"./index-1fc30c2c.js";import{d as W,c as L,R as f,S as R,P as e,W as P,F as Q,X as n,r as T,b as ye,a5 as je,A as ke,V as te,_ as q,Z as M,h as Fe,N as l,U as _,n as se,j as we,e as I,Y as Je}from"./@vue-b675b877.js";import{o as he,f as le,H as We,h as V,k as ee,y as Xe,e as Ye,I as Ge}from"./naive-ui-1895f3d8.js";import{M as Qe}from"./markdown-it-b2249ee8.js";import{m as et}from"./@traptitech-1c07f09a.js";import{m as tt}from"./markdown-it-link-attributes-93fca217.js";import{H as ue}from"./highlight.js-42a3adc5.js";import"./axios-760d4776.js";import"./@vueuse-53b62710.js";import"./vue-i18n-91d1077d.js";import"./@intlify-7347860c.js";import"./@iconify-60e148d4.js";import"./vooks-2fdfc711.js";import"./evtd-b614532e.js";import"./katex-8f8f1adc.js";import"./vdirs-b0483831.js";import"./treemate-25c27bff.js";import"./seemly-411025cc.js";import"./vueuc-67ee9856.js";import"./@css-render-563acc61.js";import"./@juggle-41516555.js";import"./css-render-d3958e6a.js";import"./@emotion-8a8e73f6.js";import"./lodash-es-cabc0acd.js";import"./date-fns-975a2d8f.js";import"./uc.micro-740ead6f.js";import"./mdurl-79eba04e.js";import"./linkify-it-191b779c.js";import"./punycode-2e8fe4e9.js";const ot={key:1,class:"text-[28px] dark:text-white"},nt=n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32","aria-hidden":"true",width:"1em",height:"1em"},[n("path",{d:"M29.71,13.09A8.09,8.09,0,0,0,20.34,2.68a8.08,8.08,0,0,0-13.7,2.9A8.08,8.08,0,0,0,2.3,18.9,8,8,0,0,0,3,25.45a8.08,8.08,0,0,0,8.69,3.87,8,8,0,0,0,6,2.68,8.09,8.09,0,0,0,7.7-5.61,8,8,0,0,0,5.33-3.86A8.09,8.09,0,0,0,29.71,13.09Zm-12,16.82a6,6,0,0,1-3.84-1.39l.19-.11,6.37-3.68a1,1,0,0,0,.53-.91v-9l2.69,1.56a.08.08,0,0,1,.05.07v7.44A6,6,0,0,1,17.68,29.91ZM4.8,24.41a6,6,0,0,1-.71-4l.19.11,6.37,3.68a1,1,0,0,0,1,0l7.79-4.49V22.8a.09.09,0,0,1,0,.08L13,26.6A6,6,0,0,1,4.8,24.41ZM3.12,10.53A6,6,0,0,1,6.28,7.9v7.57a1,1,0,0,0,.51.9l7.75,4.47L11.85,22.4a.14.14,0,0,1-.09,0L5.32,18.68a6,6,0,0,1-2.2-8.18Zm22.13,5.14-7.78-4.52L20.16,9.6a.08.08,0,0,1,.09,0l6.44,3.72a6,6,0,0,1-.9,10.81V16.56A1.06,1.06,0,0,0,25.25,15.67Zm2.68-4-.19-.12-6.36-3.7a1,1,0,0,0-1.05,0l-7.78,4.49V9.2a.09.09,0,0,1,0-.09L19,5.4a6,6,0,0,1,8.91,6.21ZM11.08,17.15,8.38,15.6a.14.14,0,0,1-.05-.08V8.1a6,6,0,0,1,9.84-4.61L18,3.6,11.61,7.28a1,1,0,0,0-.53.91ZM12.54,14,16,12l3.47,2v4L16,20l-3.47-2Z",fill:"currentColor"})],-1),at=[nt],st=W({__name:"Avatar",props:{image:{type:Boolean}},setup(t){const s=de(),i=L(()=>s.userInfo.avatar);return(c,u)=>t.image?(f(),R(Q,{key:0},[e(Ne)(e(i))&&e(i).length>0?(f(),P(e(he),{key:0,src:e(i),"fallback-src":e(ge)},null,8,["src","fallback-src"])):(f(),P(e(he),{key:1,round:"",src:e(ge)},null,8,["src"]))],64)):(f(),R("span",ot,at))}});function Ce(t){return new Promise((s,i)=>{try{const c=document.createElement("textarea");c.setAttribute("readonly","readonly"),c.value=t,document.body.appendChild(c),c.select(),document.execCommand("copy")&&document.execCommand("copy"),document.body.removeChild(c),s(t)}catch(c){i(c)}})}const rt={key:0},lt=["innerHTML"],it=["textContent"],ct=["textContent"],ut={key:2,class:"dark:text-white w-[4px] h-[20px] block animate-blink"},dt=W({__name:"Text",props:{inversion:{type:Boolean},error:{type:Boolean},text:null,loading:{type:Boolean},asRawText:{type:Boolean}},setup(t){const s=t,{isMobile:i}=pe(),c=T(),u=new Qe({html:!1,linkify:!0,highlight(x,p){if(!!(p&&ue.getLanguage(p))){const y=p??"";return k(ue.highlight(x,{language:y}).value,y)}return k(ue.highlightAuto(x).value,"")}});u.use(tt,{attrs:{target:"_blank",rel:"noopener"}}),u.use(et,{blockClass:"katexmath-block rounded-md p-[10px]",errorColor:" #cc0000"});const r=L(()=>["text-wrap","min-w-[20px]","rounded-md",i.value?"p-2":"px-3 py-2",s.inversion?"bg-[#d2f9d1]":"bg-[#f4f6f8]",s.inversion?"dark:bg-[#a1dc95]":"dark:bg-[#1e1e20]",s.inversion?"message-request":"message-reply",{"text-red-500":s.error}]),d=L(()=>{const x=s.text??"";return s.asRawText?x:u.render(x)});function k(x,p){return`<pre class="code-block-wrapper"><div class="code-block-header"><span class="code-block-header__lang">${p}</span><span class="code-block-header__copy">${h("chat.copyCode")}</span></div><code class="hljs code-block-body ${p}">${x}</code></pre>`}function b(){c.value&&c.value.querySelectorAll(".code-block-header__copy").forEach(p=>{p.addEventListener("click",()=>{var y,N;const S=(N=(y=p.parentElement)==null?void 0:y.nextElementSibling)==null?void 0:N.textContent;S&&Ce(S).then(()=>{p.textContent="复制成功",setTimeout(()=>{p.textContent="复制代码"},1e3)})})})}function w(){c.value&&c.value.querySelectorAll(".code-block-header__copy").forEach(p=>{p.removeEventListener("click",()=>{})})}return ye(()=>{b()}),je(()=>{b()}),ke(()=>{w()}),(x,p)=>(f(),R("div",{class:M(["text-black",e(r)])},[n("div",{ref_key:"textRef",ref:c,class:"leading-relaxed break-words"},[t.inversion?(f(),R("div",{key:1,class:"whitespace-pre-wrap",textContent:te(e(d))},null,8,ct)):(f(),R("div",rt,[t.asRawText?(f(),R("div",{key:1,class:"whitespace-pre-wrap",textContent:te(e(d))},null,8,it)):(f(),R("div",{key:0,class:"markdown-body",innerHTML:e(d)},null,8,lt))])),t.loading?(f(),R("span",ut)):q("",!0)],512)],2))}});const pt=()=>({iconRender:s=>{const{color:i,fontSize:c,icon:u}=s,r={};return i&&(r.color=i),c&&(r.fontSize=`${c}px`),u||window.console.warn("iconRender: icon is required"),()=>Fe(E,{icon:u,style:r})}}),ft={class:"flex flex-col"},vt={class:"transition text-neutral-300 hover:text-neutral-800 dark:hover:text-neutral-200"},gt=W({__name:"index",props:{dateTime:null,text:null,inversion:{type:Boolean},error:{type:Boolean},loading:{type:Boolean}},emits:["regenerate","delete"],setup(t,{emit:s}){const i=t,{isMobile:c}=pe(),{iconRender:u}=pt(),r=le(),d=T(),k=T(i.inversion),b=T(),w=L(()=>{const y=[{label:h("chat.copy"),key:"copyText",icon:u({icon:"ri:file-copy-2-line"})},{label:h("common.delete"),key:"delete",icon:u({icon:"ri:delete-bin-line"})}];return i.inversion||y.unshift({label:k.value?h("chat.preview"):h("chat.showRawText"),key:"toggleRenderType",icon:u({icon:k.value?"ic:outline-code-off":"ic:outline-code"})}),y});function x(y){switch(y){case"copyText":S();return;case"toggleRenderType":k.value=!k.value;return;case"delete":s("delete")}}function p(){var y;(y=b.value)==null||y.scrollIntoView(),s("regenerate")}async function S(){try{await Ce(i.text||""),r.success("复制成功")}catch{r.error("复制失败")}}return(y,N)=>(f(),R("div",{ref_key:"messageRef",ref:b,class:M(["flex w-full mb-6 overflow-hidden",[{"flex-row-reverse":t.inversion}]])},[n("div",{class:M(["flex items-center justify-center flex-shrink-0 h-8 overflow-hidden rounded-full basis-8",[t.inversion?"ml-2":"mr-2"]])},[l(st,{image:t.inversion},null,8,["image"])],2),n("div",{class:M(["overflow-hidden text-base",[t.inversion?"items-end":"items-start"]])},[n("p",{class:M(["text-xs text-[#b4bbc4]",[t.inversion?"text-right":"text-left"]])},te(t.dateTime),3),n("div",{class:M(["flex items-end gap-1 mt-2",[t.inversion?"flex-row-reverse":"flex-row"]])},[l(dt,{ref_key:"textRef",ref:d,inversion:t.inversion,error:t.error,text:t.text,loading:t.loading,"as-raw-text":k.value,class:M([t.inversion?"mySay":"gptSay"])},null,8,["inversion","error","text","loading","as-raw-text","class"]),n("div",ft,[t.inversion?q("",!0):(f(),R("button",{key:0,class:"mb-2 transition text-neutral-300 hover:text-neutral-800 dark:hover:text-neutral-300",onClick:p},[l(e(E),{icon:"ri:restart-line"})])),l(e(We),{trigger:e(c)?"click":"hover",placement:t.inversion?"left":"right",options:e(w),onSelect:x},{default:_(()=>[n("button",vt,[l(e(E),{icon:"ri:more-2-fill"})])]),_:1},8,["trigger","placement","options"])])],2)],2)],2))}});function mt(){const t=T(null);return{scrollRef:t,scrollToBottom:async()=>{await se(),t.value&&(t.value.scrollTop=t.value.scrollHeight)},scrollToTop:async()=>{await se(),t.value&&(t.value.scrollTop=0)},scrollToBottomIfAtBottom:async()=>{await se(),t.value&&t.value.scrollHeight-t.value.scrollTop-t.value.clientHeight<=100&&(t.value.scrollTop=t.value.scrollHeight)}}}function ht(){const t=re();return{addChat:(d,k)=>{t.addChatByUuid(d,k)},updateChat:(d,k,b)=>{t.updateChatByUuid(d,k,b)},updateChatSome:(d,k,b)=>{t.updateChatSomeByUuid(d,k,b)},getChatByUuidAndIndex:(d,k)=>t.getChatByUuidAndIndex(d,k),getChatData:()=>t.getChatData()}}function xt(){const t=le(),s=re(),i=L(()=>s.usingContext);function c(){s.setUsingContext(!i.value),i.value?t.success(h("chat.turnOnContext")):t.warning(h("chat.turnOffContext"))}return{usingContext:i,toggleUsingContext:c}}const yt={class:"sticky top-0 left-0 right-0 z-30 border-b dark:border-neutral-800 bg-white/80 dark:bg-black/20 backdrop-blur"},kt={class:"relative flex items-center justify-between min-w-0 overflow-hidden h-14"},wt={class:"flex items-center"},Ct={class:"flex items-center space-x-2"},_t={class:"text-xl text-[#4f555e] dark:text-white"},bt=W({__name:"index",props:{usingContext:{type:Boolean}},emits:["export","toggleUsingContext"],setup(t,{emit:s}){const i=Ke(),c=re(),u=L(()=>i.siderCollapsed),r=L(()=>c.getChatHistoryByCurrentActive);function d(){i.setSiderCollapsed(!u.value)}function k(){const x=document.querySelector("#scrollRef");x&&se(()=>x.scrollTop=0)}function b(){s("export")}function w(){s("toggleUsingContext")}return(x,p)=>{var S;return f(),R("header",yt,[n("div",kt,[n("div",wt,[n("button",{class:"flex items-center justify-center w-11 h-11",onClick:d},[e(u)?(f(),P(e(E),{key:0,class:"text-2xl",icon:"ri:align-justify"})):(f(),P(e(E),{key:1,class:"text-2xl",icon:"ri:align-right"}))])]),n("h1",{class:"flex-1 px-4 pr-6 overflow-hidden cursor-pointer select-none text-ellipsis whitespace-nowrap",onDblclick:k},te(((S=e(r))==null?void 0:S.title)??""),33),n("div",Ct,[l(e(G),{onClick:w},{default:_(()=>[n("span",{class:M(["text-xl",{"text-[#154EC1]":t.usingContext,"text-[#a8071a]":!t.usingContext}])},[l(e(E),{icon:"ri:chat-history-line"})],2)]),_:1}),l(e(G),{onClick:b},{default:_(()=>[n("span",_t,[l(e(E),{icon:"ri:download-2-line"})])]),_:1})])])])}}}),Tt={class:"p-10 bg-white rounded dark:bg-slate-800"},St={class:"space-y-4"},$t={class:"space-y-2",style:{position:"relative"}},Bt=n("div",{style:{background:"linear-gradient(139deg, rgb(254 50 50) 10.79%, rgb(27 153 239) 87.08%)",color:"rgb(255, 255, 255)",position:"absolute",right:"68px","font-size":"0.9rem",top:"3px",width:"49px",height:"25px","text-align":"center","line-height":"25px","border-radius":"11px"}}," 免费 ",-1),Rt={class:"text-2xl font-bold text-center text-slate-800 dark:text-neutral-200",style:{"font-size":"1.8rem"}},At=n("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[I(" 🤖以继续免费和我对话"),n("br")],-1),Ut={style:{"text-align":"right","font-size":"0.8rem"}},It=n("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[I(" 🎉仅剩一步！即将和我继续对话~"),n("br")],-1),Lt=n("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[I(" 🎉仅剩一步！即将和我对话~"),n("br")],-1),Et={style:{"text-align":"right","font-size":"0.8rem"}},Ot=W({__name:"Permission",props:{visible:{type:Boolean}},emits:["canClose"],setup(t,{emit:s}){const i=de(),c=xe(),u=T("register_step1");we(()=>c.modalType,(a,v)=>{a&&(u.value=a)},{immediate:!0});const r=le(),d=T(!1);function k(a){a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),oe())}function b(a){a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),J())}const w=T(""),x=T(""),p=T(""),S=T(""),y=T(""),N=T("");async function oe(){if(!w.value){r.error("请输入email");return}if(!F(w.value)){r.error("email格式不正确，请重新输入");return}try{d.value=!0;const a=await Ze(w.value);r.success("已向邮箱发送验证码，请注意查收~"),N.value=a.SCC,console.log(N.value),u.value="register_step2"}catch(a){r.error(a.message??"error")}finally{d.value=!1}}function F(a){const v=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return console.log(v.test(a)),v.test(a)}async function J(){if(!/^\d{6}$/.test(x.value)){r.error("邮箱验证码格式错误，应为六位数字");return}if(p.value!==S.value){r.error("两次输入的密码不一样");return}if(!/^[A-Za-z0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]{6,15}$/.test(p.value)){r.error("密码格式错误，应该为6~15位数字、字母、常用符号的任意组合");return}if(!/^[a-zA-Z0-9_\-.u4e00-\u9FA5]+$/.test(y.value)&&(y.value.length<2||y.value.length>20)){r.error("用户名格式错误，应该为2~20个字符之间的数字、字母、常用符号的任意组合");return}try{d.value=!0,await qe(w.value,x.value,y.value,p.value,N.value),r.success("注册成功！自动为您登陆……"),s("canClose",!0),i.updateUserInfo({name:y.value,isLogin:!0,vip:0})}catch(a){r.error(a.message??"error")}finally{d.value=!1}}function j(a){u.value=a}const z=T(""),C=T(""),U=T("");async function ne(){if(!z.value){r.error("请输入用户名或Email");return}if(F(z.value))U.value="email";else if(/^[a-zA-Z0-9_\-.u4e00-\u9FA5]+$/.test(z.value)||z.value.length<2||z.value.length>20)U.value="username";else{r.error("账号格式错误，请输入用户名或Email");return}if(!/^[A-Za-z0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]{6,15}$/.test(C.value)){r.error("密码格式错误，应该为6~15位数字、字母、常用符号的任意组合");return}try{d.value=!0;const a=await He(z.value,C.value,U.value);r.success(`登录成功！欢迎${a.userName}`),s("canClose",!0),i.updateUserInfo({name:a.userName,isLogin:!0,vip:0})}catch(a){r.error(a.message??"error")}finally{d.value=!1}}function O(){s("canClose",!0)}return(a,v)=>(f(),P(e(Xe),{show:t.visible,"auto-focus":!1,style:{width:"90%","max-width":"380px"},onMaskClick:O},{default:_(()=>[n("div",Tt,[n("div",St,[n("header",$t,[Bt,n("h2",Rt,te(u.value==="register_step1"||u.value==="register_step2"?"注册":"登录"),1)]),u.value==="register_step1"?(f(),R(Q,{key:0},[At,l(e(V),{value:w.value,"onUpdate:value":v[0]||(v[0]=$=>w.value=$),type:"text",size:"large",autofocus:!1,placeholder:"请输入电子邮箱,如xxx@xxx.xxx",onKeypress:k},{prefix:_(()=>[I(" Email ")]),_:1},8,["value"]),n("div",Ut,[n("a",{style:{cursor:"pointer"},onClick:v[1]||(v[1]=$=>j("login"))},"已有账号，立即登录->")]),l(e(ee),{block:"",color:"#8a2be2",size:"large",loading:d.value,style:{"margin-top":"15px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:oe},{default:_(()=>[I(" 使用电子邮箱注册 ")]),_:1},8,["loading"])],64)):q("",!0),u.value=="register_step2"?(f(),R(Q,{key:1},[It,l(e(V),{value:x.value,"onUpdate:value":v[2]||(v[2]=$=>x.value=$),size:"large",placeholder:"Email收到的6位数字验证码",onKeypress:b},{prefix:_(()=>[I(" 验证码 ")]),_:1},8,["value"]),l(e(V),{value:y.value,"onUpdate:value":v[3]||(v[3]=$=>y.value=$),size:"large",placeholder:"请设置用户名,可中文可英文",onKeypress:b},{prefix:_(()=>[I(" 用户名 ")]),_:1},8,["value"]),l(e(V),{value:p.value,"onUpdate:value":v[4]||(v[4]=$=>p.value=$),size:"large",type:"password",placeholder:"请设置密码",onKeypress:b},{prefix:_(()=>[I(" 密码 ")]),_:1},8,["value"]),l(e(V),{value:S.value,"onUpdate:value":v[5]||(v[5]=$=>S.value=$),size:"large",type:"password",placeholder:"请再次输入密码",onKeypress:b},{prefix:_(()=>[I(" 密码 ")]),_:1},8,["value"]),l(e(ee),{block:"",color:"#8a2be2",size:"large",loading:d.value,style:{"margin-top":"20px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:J},{default:_(()=>[I(" 注册并登录 ")]),_:1},8,["loading"])],64)):q("",!0),u.value==="login"?(f(),R(Q,{key:2},[Lt,l(e(V),{value:z.value,"onUpdate:value":v[6]||(v[6]=$=>z.value=$),size:"large",placeholder:"请输入用户名或Email",onKeypress:b},{prefix:_(()=>[I(" 账号 ")]),_:1},8,["value"]),l(e(V),{value:C.value,"onUpdate:value":v[7]||(v[7]=$=>C.value=$),size:"large",type:"password",placeholder:"请输入密码",onKeypress:b},{prefix:_(()=>[I(" 密码 ")]),_:1},8,["value"]),n("div",Et,[n("a",{style:{cursor:"pointer"},onClick:v[8]||(v[8]=$=>j("register_step1"))},"没有账号，立即注册->")]),l(e(ee),{block:"",color:"#8a2be2",size:"large",loading:d.value,style:{"margin-top":"20px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:ne},{default:_(()=>[I(" 登录 ")]),_:1},8,["loading"])],64)):q("",!0)])])]),_:1},8,["show"]))}});const zt={class:"flex flex-col w-full h-full"},Dt={class:"flex-1 overflow-hidden"},Mt={key:0,class:"flex items-center justify-center mt-4 text-center text-neutral-300"},Pt=n("span",null,"Aha~",-1),Nt={key:1},Kt={class:"sticky bottom-0 left-0 flex justify-center"},Zt={class:"w-full max-w-screen-xl m-auto"},qt={class:"flex items-center justify-between space-x-2"},Ht={class:"text-xl text-[#4f555e] dark:text-white"},Vt={class:"text-xl text-[#4f555e] dark:text-white"},jt={class:"dark:text-black"},So=W({__name:"index",setup(t){let s=new AbortController;const i=!1,c=De(),u=Ye(),r=le(),d=re(),k=de(),b=L(()=>k.userInfo),{isMobile:w}=pe(),{addChat:x,updateChat:p,updateChatSome:S,getChatByUuidAndIndex:y,getChatData:N}=ht(),{scrollRef:oe,scrollToBottom:F,scrollToBottomIfAtBottom:J}=mt(),{usingContext:j,toggleUsingContext:z}=xt(),{uuid:C}=c.params,U=L(()=>d.getChatByUuid(+C)),ne=L(()=>U.value.filter(o=>!o.inversion&&!!o.conversationOptions)),O=T(""),a=T(!1),v=T(null),$=xe(),ae=T(!1);we(()=>$.showModal,(o,g)=>{o&&!g&&(ae.value=!0,$.updateSetting({showModal:!1,modalType:"login"}))},{immediate:!0});const _e=Ve(),{promptList:fe}=Me(_e);U.value.forEach((o,g)=>{o.loading&&S(+C,g,{loading:!1})});function ie(){Le.value||ze()&&be()}async function be(){var A;let o=O.value;if(a.value||!o||o.trim()==="")return;s=new AbortController,x(+C,{dateTime:new Date().toLocaleString(),text:o,inversion:!0,error:!1,conversationOptions:null,requestOptions:{prompt:o,options:null}}),F(),a.value=!0,O.value="";let g={};const B=(A=ne.value[ne.value.length-1])==null?void 0:A.conversationOptions;B&&j.value&&(g={...B}),x(+C,{dateTime:new Date().toLocaleString(),text:"",loading:!0,inversion:!1,error:!1,conversationOptions:null,requestOptions:{prompt:o,options:{...g}}}),F();try{let m="";await(async()=>{await me({prompt:o,options:g,signal:s.signal,onDownloadProgress:({event:K})=>{const ce=K.target,{responseText:Z}=ce,X=Z.lastIndexOf(`
`,Z.length-2);let Y=Z;X!==-1&&(Y=Z.substring(X));try{const D=JSON.parse(Y);p(+C,U.value.length-1,{dateTime:new Date().toLocaleString(),text:m+(D.text??""),inversion:!1,error:!1,loading:!0,conversationOptions:{conversationId:D.conversationId,parentMessageId:D.id},requestOptions:{prompt:o,options:{...g}}}),i&&D.detail.choices[0].finish_reason,J()}catch{}}}),S(+C,U.value.length-1,{loading:!1})})()}catch(m){const H=(m==null?void 0:m.message)??h("common.wrong");if(m.message==="canceled"){S(+C,U.value.length-1,{loading:!1}),J();return}const K=y(+C,U.value.length-1);if(K!=null&&K.text&&K.text!==""){S(+C,U.value.length-1,{text:`${K.text}
[${H}]`,error:!1,loading:!1});return}p(+C,U.value.length-1,{dateTime:new Date().toLocaleString(),text:H,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:o,options:{...g}}}),J()}finally{a.value=!1}}async function Te(o){if(a.value)return;s=new AbortController;const{requestOptions:g}=U.value[o];let B=(g==null?void 0:g.prompt)??"",A={};g.options&&(A={...g.options}),a.value=!0,p(+C,o,{dateTime:new Date().toLocaleString(),text:"",inversion:!1,error:!1,loading:!0,conversationOptions:null,requestOptions:{prompt:B,options:{...A}}});try{let m="";await(async()=>{await me({prompt:B,options:A,signal:s.signal,onDownloadProgress:({event:K})=>{const ce=K.target,{responseText:Z}=ce,X=Z.lastIndexOf(`
`,Z.length-2);let Y=Z;X!==-1&&(Y=Z.substring(X));try{const D=JSON.parse(Y);p(+C,o,{dateTime:new Date().toLocaleString(),text:m+(D.text??""),inversion:!1,error:!1,loading:!0,conversationOptions:{conversationId:D.conversationId,parentMessageId:D.id},requestOptions:{prompt:B,options:{...A}}}),i&&D.detail.choices[0].finish_reason}catch{}}}),S(+C,o,{loading:!1})})()}catch(m){if(m.message==="canceled"){S(+C,o,{loading:!1});return}const H=(m==null?void 0:m.message)??h("common.wrong");p(+C,o,{dateTime:new Date().toLocaleString(),text:H,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:B,options:{...A}}})}finally{a.value=!1}}function ve(){if(a.value)return;const o=u.warning({title:h("chat.exportImage"),content:h("chat.exportImageConfirm"),positiveText:h("common.yes"),negativeText:h("common.no"),onPositiveClick:async()=>{try{o.loading=!0;const g=document.getElementById("image-wrapper"),A=(await Pe(g,{useCORS:!0})).toDataURL("image/png"),m=document.createElement("a");m.style.display="none",m.href=A,m.setAttribute("download","chat-shot.png"),typeof m.download>"u"&&m.setAttribute("target","_blank"),document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(A),o.loading=!1,r.success(h("chat.exportSuccess")),Promise.resolve()}catch{r.error(h("chat.exportFailed"))}finally{o.loading=!1}}})}function Se(o){a.value||u.warning({title:h("chat.deleteMessage"),content:h("chat.deleteMessageConfirm"),positiveText:h("common.yes"),negativeText:h("common.no"),onPositiveClick:()=>{d.deleteChatByUuid(+C,o)}})}function $e(){a.value||u.warning({title:h("chat.clearChat"),content:h("chat.clearChatConfirm"),positiveText:h("common.yes"),negativeText:h("common.no"),onPositiveClick:()=>{d.clearChatByUuid(+C)}})}function Be(o){w.value?o.key==="Enter"&&o.ctrlKey&&(o.preventDefault(),ie()):o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),ie())}function Re(){a.value&&(s.abort(),a.value=!1)}const Ae=L(()=>O.value.startsWith("/")?fe.value.filter(o=>o.key.toLowerCase().includes(O.value.substring(1).toLowerCase())).map(o=>({label:o.value,value:o.value})):[]),Ue=o=>{for(const g of fe.value)if(g.value===o.label)return[g.key];return[]},Ie=L(()=>w.value?h("chat.placeholderMobile"):h("chat.placeholder")),Le=L(()=>a.value||!O.value||O.value.trim()===""),Ee=L(()=>{let o=["p-4"];return w.value&&(o=["sticky","left-0","bottom-0","right-0","p-2","pr-3","overflow-hidden"]),o});ye(()=>{var o;F(),v.value&&!w.value&&((o=v.value)==null||o.focus())}),ke(()=>{a.value&&s.abort()});function Oe(){ae.value=!1}function ze(){return b.value.isLogin?!0:N()[0].data.length>=4?(console.log("login"),ae.value=!0,!1):!0}return(o,g)=>(f(),R("div",zt,[e(w)?(f(),P(bt,{key:0,"using-context":e(j),onExport:ve,onToggleUsingContext:e(z)},null,8,["using-context","onToggleUsingContext"])):q("",!0),n("main",Dt,[n("div",{id:"scrollRef",ref_key:"scrollRef",ref:oe,class:"h-full overflow-hidden overflow-y-auto"},[n("div",{id:"image-wrapper",class:M(["w-full max-w-screen-xl m-auto dark:bg-[#101014]",[e(w)?"p-2":"p-4"]])},[e(U).length?(f(),R("div",Nt,[(f(!0),R(Q,null,Je(e(U),(B,A)=>(f(),P(e(gt),{key:A,"date-time":B.dateTime,text:B.text,inversion:B.inversion,error:B.error,loading:B.loading,onRegenerate:m=>Te(A),onDelete:m=>Se(A)},null,8,["date-time","text","inversion","error","loading","onRegenerate","onDelete"]))),128)),n("div",Kt,[a.value?(f(),P(e(ee),{key:0,type:"warning",onClick:Re},{icon:_(()=>[l(e(E),{icon:"ri:stop-circle-line"})]),default:_(()=>[I(" Stop Responding ")]),_:1})):q("",!0)])])):(f(),R("div",Mt,[l(e(E),{icon:"ri:bubble-chart-fill",class:"mr-2 text-3xl"}),Pt]))],2)],512)]),n("footer",{class:M(e(Ee))},[n("div",Zt,[n("div",qt,[l(e(G),{onClick:$e},{default:_(()=>[n("span",Ht,[l(e(E),{icon:"ri:delete-bin-line"})])]),_:1}),e(w)?q("",!0):(f(),P(e(G),{key:0,onClick:ve},{default:_(()=>[n("span",Vt,[l(e(E),{icon:"ri:download-2-line"})])]),_:1})),e(w)?q("",!0):(f(),P(e(G),{key:1,onClick:e(z)},{default:_(()=>[n("span",{class:M(["text-xl",{"text-[#154EC1]":e(j),"text-[#a8071a]":!e(j)}])},[l(e(E),{icon:"ri:chat-history-line"})],2)]),_:1},8,["onClick"])),l(e(Ge),{value:O.value,"onUpdate:value":g[1]||(g[1]=B=>O.value=B),options:e(Ae),"render-label":Ue},{default:_(({handleInput:B,handleBlur:A,handleFocus:m})=>[l(e(V),{ref_key:"inputRef",ref:v,value:O.value,"onUpdate:value":g[0]||(g[0]=H=>O.value=H),style:{padding:"5px"},type:"textarea",placeholder:e(Ie),autosize:{minRows:1,maxRows:e(w)?4:8},onInput:B,onFocus:m,onBlur:A,onKeypress:Be},null,8,["value","placeholder","autosize","onInput","onFocus","onBlur"])]),_:1},8,["value","options"]),l(e(ee),{type:"primary",style:{padding:"21px 12px","border-radius":"21px"},onClick:ie},{icon:_(()=>[n("span",jt,[l(e(E),{icon:"ri:send-plane-fill"})])]),_:1}),l(Ot,{visible:ae.value,onCanClose:Oe},null,8,["visible"])])])],2)]))}});export{So as default};
