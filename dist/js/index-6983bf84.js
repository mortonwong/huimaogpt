import{b as ze}from"./vue-router-6dcef795.js";import{s as De}from"./pinia-7b1e1edf.js";import{h as Me}from"./html2canvas-18c4afc9.js";import{u as ue,i as Pe,d as ve,a as de,t as x,_ as Ne,b as E,c as re,e as je,f as Q,g as he,s as Ke,h as Ze,j as Ve,k as qe,l as ge}from"./index-e95d194a.js";import{d as X,c as U,R as p,S as $,P as e,W as j,F as ee,X as n,r as b,b as xe,a5 as He,A as ye,V as oe,_ as q,Z as M,h as Fe,N as c,U as C,n as se,j as _e,e as L,Y as Je}from"./@vue-b675b877.js";import{o as me,f as le,H as We,h as F,k as te,y as Xe,e as Ye,I as Ge}from"./naive-ui-1895f3d8.js";import{M as Qe}from"./markdown-it-b2249ee8.js";import{m as et}from"./@traptitech-1c07f09a.js";import{m as tt}from"./markdown-it-link-attributes-93fca217.js";import"./axios-760d4776.js";import"./@vueuse-53b62710.js";import"./vue-i18n-91d1077d.js";import"./@intlify-7347860c.js";import"./@iconify-60e148d4.js";import"./vooks-2fdfc711.js";import"./evtd-b614532e.js";import"./katex-8f8f1adc.js";import"./vdirs-b0483831.js";import"./treemate-25c27bff.js";import"./seemly-411025cc.js";import"./vueuc-67ee9856.js";import"./@css-render-563acc61.js";import"./@juggle-41516555.js";import"./css-render-d3958e6a.js";import"./@emotion-8a8e73f6.js";import"./lodash-es-cabc0acd.js";import"./date-fns-975a2d8f.js";import"./uc.micro-740ead6f.js";import"./mdurl-79eba04e.js";import"./linkify-it-191b779c.js";import"./punycode-2e8fe4e9.js";const ot={key:1,class:"text-[28px] dark:text-white"},nt=n("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32","aria-hidden":"true",width:"1em",height:"1em"},[n("path",{d:"M29.71,13.09A8.09,8.09,0,0,0,20.34,2.68a8.08,8.08,0,0,0-13.7,2.9A8.08,8.08,0,0,0,2.3,18.9,8,8,0,0,0,3,25.45a8.08,8.08,0,0,0,8.69,3.87,8,8,0,0,0,6,2.68,8.09,8.09,0,0,0,7.7-5.61,8,8,0,0,0,5.33-3.86A8.09,8.09,0,0,0,29.71,13.09Zm-12,16.82a6,6,0,0,1-3.84-1.39l.19-.11,6.37-3.68a1,1,0,0,0,.53-.91v-9l2.69,1.56a.08.08,0,0,1,.05.07v7.44A6,6,0,0,1,17.68,29.91ZM4.8,24.41a6,6,0,0,1-.71-4l.19.11,6.37,3.68a1,1,0,0,0,1,0l7.79-4.49V22.8a.09.09,0,0,1,0,.08L13,26.6A6,6,0,0,1,4.8,24.41ZM3.12,10.53A6,6,0,0,1,6.28,7.9v7.57a1,1,0,0,0,.51.9l7.75,4.47L11.85,22.4a.14.14,0,0,1-.09,0L5.32,18.68a6,6,0,0,1-2.2-8.18Zm22.13,5.14-7.78-4.52L20.16,9.6a.08.08,0,0,1,.09,0l6.44,3.72a6,6,0,0,1-.9,10.81V16.56A1.06,1.06,0,0,0,25.25,15.67Zm2.68-4-.19-.12-6.36-3.7a1,1,0,0,0-1.05,0l-7.78,4.49V9.2a.09.09,0,0,1,0-.09L19,5.4a6,6,0,0,1,8.91,6.21ZM11.08,17.15,8.38,15.6a.14.14,0,0,1-.05-.08V8.1a6,6,0,0,1,9.84-4.61L18,3.6,11.61,7.28a1,1,0,0,0-.53.91ZM12.54,14,16,12l3.47,2v4L16,20l-3.47-2Z",fill:"currentColor"})],-1),at=[nt],st=X({__name:"Avatar",props:{image:{type:Boolean}},setup(t){const r=ue(),l=U(()=>r.userInfo.avatar);return(h,f)=>t.image?(p(),$(ee,{key:0},[e(Pe)(e(l))&&e(l).length>0?(p(),j(e(me),{key:0,src:e(l),"fallback-src":e(ve)},null,8,["src","fallback-src"])):(p(),j(e(me),{key:1,round:"",src:e(ve)},null,8,["src"]))],64)):(p(),$("span",ot,at))}});function ke(t){return new Promise((r,l)=>{try{const h=document.createElement("textarea");h.setAttribute("readonly","readonly"),h.value=t,document.body.appendChild(h),h.select(),document.execCommand("copy")&&document.execCommand("copy"),document.body.removeChild(h),r(t)}catch(h){l(h)}})}const rt={key:0},lt=["innerHTML"],it=["textContent"],ct=["textContent"],ut={key:2,class:"dark:text-white w-[4px] h-[20px] block animate-blink"},dt=X({__name:"Text",props:{inversion:{type:Boolean},error:{type:Boolean},text:null,loading:{type:Boolean},asRawText:{type:Boolean}},setup(t){const r=t;let l;async function h(){if(!l){const{default:d}=await Ne(()=>import("./highlight.js-85716a15.js"),[]);l=d}}const{isMobile:f}=de(),s=b();setTimeout(h,1e3);const u=new Qe({html:!1,linkify:!0,highlight(d,i){if(!!(i&&l.getLanguage(i))){const N=i??"";return y(l.highlight(d,{language:N}).value,N)}return y(l.highlightAuto(d).value,"")}});u.use(tt,{attrs:{target:"_blank",rel:"noopener"}}),u.use(et,{blockClass:"katexmath-block rounded-md p-[10px]",errorColor:" #cc0000"});const k=U(()=>["text-wrap","min-w-[20px]","rounded-md",f.value?"p-2":"px-3 py-2",r.inversion?"bg-[#d2f9d1]":"bg-[#f4f6f8]",r.inversion?"dark:bg-[#a1dc95]":"dark:bg-[#1e1e20]",r.inversion?"message-request":"message-reply",{"text-red-500":r.error}]),w=U(()=>{const d=r.text??"";return r.asRawText?d:u.render(d)});function y(d,i){return`<pre class="code-block-wrapper"><div class="code-block-header"><span class="code-block-header__lang">${i}</span><span class="code-block-header__copy">${x("chat.copyCode")}</span></div><code class="hljs code-block-body ${i}">${d}</code></pre>`}function R(){s.value&&s.value.querySelectorAll(".code-block-header__copy").forEach(i=>{i.addEventListener("click",()=>{var N,K;const P=(K=(N=i.parentElement)==null?void 0:N.nextElementSibling)==null?void 0:K.textContent;P&&ke(P).then(()=>{i.textContent="复制成功",setTimeout(()=>{i.textContent="复制代码"},1e3)})})})}function A(){s.value&&s.value.querySelectorAll(".code-block-header__copy").forEach(i=>{i.removeEventListener("click",()=>{})})}return xe(()=>{R()}),He(()=>{R()}),ye(()=>{A()}),(d,i)=>(p(),$("div",{class:M(["text-black",e(k)])},[n("div",{ref_key:"textRef",ref:s,class:"leading-relaxed break-words"},[t.inversion?(p(),$("div",{key:1,class:"whitespace-pre-wrap",textContent:oe(e(w))},null,8,ct)):(p(),$("div",rt,[t.asRawText?(p(),$("div",{key:1,class:"whitespace-pre-wrap",textContent:oe(e(w))},null,8,it)):(p(),$("div",{key:0,class:"markdown-body",innerHTML:e(w)},null,8,lt))])),t.loading?(p(),$("span",ut)):q("",!0)],512)],2))}});const pt=()=>({iconRender:r=>{const{color:l,fontSize:h,icon:f}=r,s={};return l&&(s.color=l),h&&(s.fontSize=`${h}px`),f||window.console.warn("iconRender: icon is required"),()=>Fe(E,{icon:f,style:s})}}),ft={class:"flex flex-col"},vt={class:"transition text-neutral-300 hover:text-neutral-800 dark:hover:text-neutral-200"},gt=X({__name:"index",props:{dateTime:null,text:null,inversion:{type:Boolean},error:{type:Boolean},loading:{type:Boolean}},emits:["regenerate","delete"],setup(t,{emit:r}){const l=t,{isMobile:h}=de(),{iconRender:f}=pt(),s=le(),u=b(),k=b(l.inversion),w=b(),y=U(()=>{const i=[{label:x("chat.copy"),key:"copyText",icon:f({icon:"ri:file-copy-2-line"})},{label:x("common.delete"),key:"delete",icon:f({icon:"ri:delete-bin-line"})}];return l.inversion||i.unshift({label:k.value?x("chat.preview"):x("chat.showRawText"),key:"toggleRenderType",icon:f({icon:k.value?"ic:outline-code-off":"ic:outline-code"})}),i});function R(i){switch(i){case"copyText":d();return;case"toggleRenderType":k.value=!k.value;return;case"delete":r("delete")}}function A(){var i;(i=w.value)==null||i.scrollIntoView(),r("regenerate")}async function d(){try{await ke(l.text||""),s.success("复制成功")}catch{s.error("复制失败")}}return(i,P)=>(p(),$("div",{ref_key:"messageRef",ref:w,class:M(["flex w-full mb-6 overflow-hidden",[{"flex-row-reverse":t.inversion}]])},[n("div",{class:M(["flex items-center justify-center flex-shrink-0 h-8 overflow-hidden rounded-full basis-8",[t.inversion?"ml-2":"mr-2"]])},[c(st,{image:t.inversion},null,8,["image"])],2),n("div",{class:M(["overflow-hidden text-base",[t.inversion?"items-end":"items-start"]])},[n("p",{class:M(["text-xs text-[#b4bbc4]",[t.inversion?"text-right":"text-left"]])},oe(t.dateTime),3),n("div",{class:M(["flex items-end gap-1 mt-2",[t.inversion?"flex-row-reverse":"flex-row"]])},[c(dt,{ref_key:"textRef",ref:u,inversion:t.inversion,error:t.error,text:t.text,loading:t.loading,"as-raw-text":k.value,class:M([t.inversion?"mySay":"gptSay"])},null,8,["inversion","error","text","loading","as-raw-text","class"]),n("div",ft,[t.inversion?q("",!0):(p(),$("button",{key:0,class:"mb-2 transition text-neutral-300 hover:text-neutral-800 dark:hover:text-neutral-300",onClick:A},[c(e(E),{icon:"ri:restart-line"})])),c(e(We),{trigger:e(h)?"click":"hover",placement:t.inversion?"left":"right",options:e(y),onSelect:R},{default:C(()=>[n("button",vt,[c(e(E),{icon:"ri:more-2-fill"})])]),_:1},8,["trigger","placement","options"])])],2)],2)],2))}});function mt(){const t=b(null);return{scrollRef:t,scrollToBottom:async()=>{await se(),t.value&&(t.value.scrollTop=t.value.scrollHeight)},scrollToTop:async()=>{await se(),t.value&&(t.value.scrollTop=0)},scrollToBottomIfAtBottom:async()=>{await se(),t.value&&t.value.scrollHeight-t.value.scrollTop-t.value.clientHeight<=100&&(t.value.scrollTop=t.value.scrollHeight)}}}function ht(){const t=re();return{addChat:(u,k)=>{t.addChatByUuid(u,k)},updateChat:(u,k,w)=>{t.updateChatByUuid(u,k,w)},updateChatSome:(u,k,w)=>{t.updateChatSomeByUuid(u,k,w)},getChatByUuidAndIndex:(u,k)=>t.getChatByUuidAndIndex(u,k),getChatData:()=>t.getChatData()}}function xt(){const t=le(),r=re(),l=U(()=>r.usingContext);function h(){r.setUsingContext(!l.value),l.value?t.success(x("chat.turnOnContext")):t.warning(x("chat.turnOffContext"))}return{usingContext:l,toggleUsingContext:h}}const yt={class:"sticky top-0 left-0 right-0 z-30 border-b dark:border-neutral-800 bg-white/80 dark:bg-black/20 backdrop-blur"},_t={class:"relative flex items-center justify-between min-w-0 overflow-hidden h-14"},kt={class:"flex items-center"},wt={class:"flex items-center space-x-2"},Ct={class:"text-xl text-[#4f555e] dark:text-white"},bt=X({__name:"index",props:{usingContext:{type:Boolean}},emits:["export","toggleUsingContext"],setup(t,{emit:r}){const l=je(),h=re(),f=U(()=>l.siderCollapsed),s=U(()=>h.getChatHistoryByCurrentActive);function u(){l.setSiderCollapsed(!f.value)}function k(){const R=document.querySelector("#scrollRef");R&&se(()=>R.scrollTop=0)}function w(){r("export")}function y(){r("toggleUsingContext")}return(R,A)=>{var d;return p(),$("header",yt,[n("div",_t,[n("div",kt,[n("button",{class:"flex items-center justify-center w-11 h-11",onClick:u},[e(f)?(p(),j(e(E),{key:0,class:"text-2xl",icon:"ri:align-justify"})):(p(),j(e(E),{key:1,class:"text-2xl",icon:"ri:align-right"}))])]),n("h1",{class:"flex-1 px-4 pr-6 overflow-hidden cursor-pointer select-none text-ellipsis whitespace-nowrap",onDblclick:k},oe(((d=e(s))==null?void 0:d.title)??""),33),n("div",wt,[c(e(Q),{onClick:y},{default:C(()=>[n("span",{class:M(["text-xl",{"text-[#154EC1]":t.usingContext,"text-[#a8071a]":!t.usingContext}])},[c(e(E),{icon:"ri:chat-history-line"})],2)]),_:1}),c(e(Q),{onClick:w},{default:C(()=>[n("span",Ct,[c(e(E),{icon:"ri:download-2-line"})])]),_:1})])])])}}}),Tt={class:"p-10 bg-white rounded dark:bg-slate-800"},St={class:"space-y-4"},$t={class:"space-y-2",style:{position:"relative"}},Bt=n("div",{style:{background:"linear-gradient(139deg, rgb(254 50 50) 10.79%, rgb(27 153 239) 87.08%)",color:"rgb(255, 255, 255)",position:"absolute",right:"68px","font-size":"0.9rem",top:"3px",width:"49px",height:"25px","text-align":"center","line-height":"25px","border-radius":"11px"}}," 免费 ",-1),Rt={class:"text-2xl font-bold text-center text-slate-800 dark:text-neutral-200",style:{"font-size":"1.8rem"}},At=n("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[L(" 🤖以继续免费和我对话"),n("br")],-1),It={style:{"text-align":"right","font-size":"0.8rem"}},Lt=n("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[L(" 🎉仅剩一步！即将和我继续对话~"),n("br")],-1),Ut=n("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[L(" 🎉仅剩一步！即将和我对话~"),n("br")],-1),Et={style:{"text-align":"right","font-size":"0.8rem"}},Ot=X({__name:"Permission",props:{visible:{type:Boolean}},emits:["canClose"],setup(t,{emit:r}){const l=ue(),h=he(),f=b("register_step1");_e(()=>h.modalType,(a,v)=>{a&&(f.value=a)},{immediate:!0});const s=le(),u=b(!1);function k(a){a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),N())}function w(a){a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),W())}const y=b(""),R=b(""),A=b(""),d=b(""),i=b(""),P=b("");async function N(){if(!y.value){s.error("请输入email");return}if(!K(y.value)){s.error("email格式不正确，请重新输入");return}try{u.value=!0;const a=await Ke(y.value);s.success("已向邮箱发送验证码，请注意查收~"),P.value=a.SCC,console.log(P.value),f.value="register_step2"}catch(a){s.error(a.message??"error")}finally{u.value=!1}}function K(a){const v=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return console.log(v.test(a)),v.test(a)}async function W(){if(!/^\d{6}$/.test(R.value)){s.error("邮箱验证码格式错误，应为六位数字");return}if(A.value!==d.value){s.error("两次输入的密码不一样");return}if(!/^[A-Za-z0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]{6,15}$/.test(A.value)){s.error("密码格式错误，应该为6~15位数字、字母、常用符号的任意组合");return}if(!/^[a-zA-Z0-9_\-.u4e00-\u9FA5]+$/.test(i.value)&&(i.value.length<2||i.value.length>20)){s.error("用户名格式错误，应该为2~20个字符之间的数字、字母、常用符号的任意组合");return}try{u.value=!0,await Ze(y.value,R.value,i.value,A.value,P.value),s.success("注册成功！自动为您登陆……"),r("canClose",!0),l.updateUserInfo({name:i.value,isLogin:!0,vip:0})}catch(a){s.error(a.message??"error")}finally{u.value=!1}}function J(a){f.value=a}const z=b(""),_=b(""),I=b("");async function ne(){if(!z.value){s.error("请输入用户名或Email");return}if(K(z.value))I.value="email";else if(/^[a-zA-Z0-9_\-.u4e00-\u9FA5]+$/.test(z.value)||z.value.length<2||z.value.length>20)I.value="username";else{s.error("账号格式错误，请输入用户名或Email");return}if(!/^[A-Za-z0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]{6,15}$/.test(_.value)){s.error("密码格式错误，应该为6~15位数字、字母、常用符号的任意组合");return}try{u.value=!0;const a=await Ve(z.value,_.value,I.value);s.success(`登录成功！欢迎${a.userName}`),r("canClose",!0),l.updateUserInfo({name:a.userName,isLogin:!0,vip:0})}catch(a){s.error(a.message??"error")}finally{u.value=!1}}function O(){r("canClose",!0)}return(a,v)=>(p(),j(e(Xe),{show:t.visible,"auto-focus":!1,style:{width:"90%","max-width":"380px"},onMaskClick:O},{default:C(()=>[n("div",Tt,[n("div",St,[n("header",$t,[Bt,n("h2",Rt,oe(f.value==="register_step1"||f.value==="register_step2"?"注册":"登录"),1)]),f.value==="register_step1"?(p(),$(ee,{key:0},[At,c(e(F),{value:y.value,"onUpdate:value":v[0]||(v[0]=T=>y.value=T),type:"text",size:"large",autofocus:!1,placeholder:"请输入电子邮箱,如xxx@xxx.xxx",onKeypress:k},{prefix:C(()=>[L(" Email ")]),_:1},8,["value"]),n("div",It,[n("a",{style:{cursor:"pointer"},onClick:v[1]||(v[1]=T=>J("login"))},"已有账号，立即登录->")]),c(e(te),{block:"",color:"#8a2be2",size:"large",loading:u.value,style:{"margin-top":"15px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:N},{default:C(()=>[L(" 使用电子邮箱注册 ")]),_:1},8,["loading"])],64)):q("",!0),f.value=="register_step2"?(p(),$(ee,{key:1},[Lt,c(e(F),{value:R.value,"onUpdate:value":v[2]||(v[2]=T=>R.value=T),size:"large",placeholder:"Email收到的6位数字验证码",onKeypress:w},{prefix:C(()=>[L(" 验证码 ")]),_:1},8,["value"]),c(e(F),{value:i.value,"onUpdate:value":v[3]||(v[3]=T=>i.value=T),size:"large",placeholder:"请设置用户名,可中文可英文",onKeypress:w},{prefix:C(()=>[L(" 用户名 ")]),_:1},8,["value"]),c(e(F),{value:A.value,"onUpdate:value":v[4]||(v[4]=T=>A.value=T),size:"large",type:"password",placeholder:"请设置密码",onKeypress:w},{prefix:C(()=>[L(" 密码 ")]),_:1},8,["value"]),c(e(F),{value:d.value,"onUpdate:value":v[5]||(v[5]=T=>d.value=T),size:"large",type:"password",placeholder:"请再次输入密码",onKeypress:w},{prefix:C(()=>[L(" 密码 ")]),_:1},8,["value"]),c(e(te),{block:"",color:"#8a2be2",size:"large",loading:u.value,style:{"margin-top":"20px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:W},{default:C(()=>[L(" 注册并登录 ")]),_:1},8,["loading"])],64)):q("",!0),f.value==="login"?(p(),$(ee,{key:2},[Ut,c(e(F),{value:z.value,"onUpdate:value":v[6]||(v[6]=T=>z.value=T),size:"large",placeholder:"请输入用户名或Email",onKeypress:w},{prefix:C(()=>[L(" 账号 ")]),_:1},8,["value"]),c(e(F),{value:_.value,"onUpdate:value":v[7]||(v[7]=T=>_.value=T),size:"large",type:"password",placeholder:"请输入密码",onKeypress:w},{prefix:C(()=>[L(" 密码 ")]),_:1},8,["value"]),n("div",Et,[n("a",{style:{cursor:"pointer"},onClick:v[8]||(v[8]=T=>J("register_step1"))},"没有账号，立即注册->")]),c(e(te),{block:"",color:"#8a2be2",size:"large",loading:u.value,style:{"margin-top":"20px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:ne},{default:C(()=>[L(" 登录 ")]),_:1},8,["loading"])],64)):q("",!0)])])]),_:1},8,["show"]))}});const zt={class:"flex flex-col w-full h-full"},Dt={class:"flex-1 overflow-hidden"},Mt={key:0,class:"flex items-center justify-center mt-4 text-center text-neutral-300"},Pt=n("span",null,"Aha~",-1),Nt={key:1},jt={class:"sticky bottom-0 left-0 flex justify-center"},Kt={class:"w-full max-w-screen-xl m-auto"},Zt={class:"flex items-center justify-between space-x-2"},Vt={class:"text-xl text-[#4f555e] dark:text-white"},qt={class:"text-xl text-[#4f555e] dark:text-white"},Ht={class:"dark:text-black"},To=X({__name:"index",setup(t){let r=new AbortController;const l=!1,h=ze(),f=Ye(),s=le(),u=re(),k=ue(),w=U(()=>k.userInfo),{isMobile:y}=de(),{addChat:R,updateChat:A,updateChatSome:d,getChatByUuidAndIndex:i,getChatData:P}=ht(),{scrollRef:N,scrollToBottom:K,scrollToBottomIfAtBottom:W}=mt(),{usingContext:J,toggleUsingContext:z}=xt(),{uuid:_}=h.params,I=U(()=>u.getChatByUuid(+_)),ne=U(()=>I.value.filter(o=>!o.inversion&&!!o.conversationOptions)),O=b(""),a=b(!1),v=b(null),T=he(),ae=b(!1);_e(()=>T.showModal,(o,g)=>{o&&!g&&(ae.value=!0,T.updateSetting({showModal:!1,modalType:"login"}))},{immediate:!0});const we=qe(),{promptList:pe}=De(we);I.value.forEach((o,g)=>{o.loading&&d(+_,g,{loading:!1})});function ie(){Le.value||Oe()&&Ce()}async function Ce(){var B;let o=O.value;if(a.value||!o||o.trim()==="")return;r=new AbortController,R(+_,{dateTime:new Date().toLocaleString(),text:o,inversion:!0,error:!1,conversationOptions:null,requestOptions:{prompt:o,options:null}}),K(),a.value=!0,O.value="";let g={};const S=(B=ne.value[ne.value.length-1])==null?void 0:B.conversationOptions;S&&J.value&&(g={...S}),R(+_,{dateTime:new Date().toLocaleString(),text:"",loading:!0,inversion:!1,error:!1,conversationOptions:null,requestOptions:{prompt:o,options:{...g}}}),K();try{let m="";await(async()=>{await ge({prompt:o,options:g,signal:r.signal,onDownloadProgress:({event:Z})=>{const ce=Z.target,{responseText:V}=ce,Y=V.lastIndexOf(`
`,V.length-2);let G=V;Y!==-1&&(G=V.substring(Y));try{const D=JSON.parse(G);A(+_,I.value.length-1,{dateTime:new Date().toLocaleString(),text:m+(D.text??""),inversion:!1,error:!1,loading:!0,conversationOptions:{conversationId:D.conversationId,parentMessageId:D.id},requestOptions:{prompt:o,options:{...g}}}),l&&D.detail.choices[0].finish_reason,W()}catch{}}}),d(+_,I.value.length-1,{loading:!1})})()}catch(m){const H=(m==null?void 0:m.message)??x("common.wrong");if(m.message==="canceled"){d(+_,I.value.length-1,{loading:!1}),W();return}const Z=i(+_,I.value.length-1);if(Z!=null&&Z.text&&Z.text!==""){d(+_,I.value.length-1,{text:`${Z.text}
[${H}]`,error:!1,loading:!1});return}A(+_,I.value.length-1,{dateTime:new Date().toLocaleString(),text:H,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:o,options:{...g}}}),W()}finally{a.value=!1}}async function be(o){if(a.value)return;r=new AbortController;const{requestOptions:g}=I.value[o];let S=(g==null?void 0:g.prompt)??"",B={};g.options&&(B={...g.options}),a.value=!0,A(+_,o,{dateTime:new Date().toLocaleString(),text:"",inversion:!1,error:!1,loading:!0,conversationOptions:null,requestOptions:{prompt:S,options:{...B}}});try{let m="";await(async()=>{await ge({prompt:S,options:B,signal:r.signal,onDownloadProgress:({event:Z})=>{const ce=Z.target,{responseText:V}=ce,Y=V.lastIndexOf(`
`,V.length-2);let G=V;Y!==-1&&(G=V.substring(Y));try{const D=JSON.parse(G);A(+_,o,{dateTime:new Date().toLocaleString(),text:m+(D.text??""),inversion:!1,error:!1,loading:!0,conversationOptions:{conversationId:D.conversationId,parentMessageId:D.id},requestOptions:{prompt:S,options:{...B}}}),l&&D.detail.choices[0].finish_reason}catch{}}}),d(+_,o,{loading:!1})})()}catch(m){if(m.message==="canceled"){d(+_,o,{loading:!1});return}const H=(m==null?void 0:m.message)??x("common.wrong");A(+_,o,{dateTime:new Date().toLocaleString(),text:H,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:S,options:{...B}}})}finally{a.value=!1}}function fe(){if(a.value)return;const o=f.warning({title:x("chat.exportImage"),content:x("chat.exportImageConfirm"),positiveText:x("common.yes"),negativeText:x("common.no"),onPositiveClick:async()=>{try{o.loading=!0;const g=document.getElementById("image-wrapper"),B=(await Me(g,{useCORS:!0})).toDataURL("image/png"),m=document.createElement("a");m.style.display="none",m.href=B,m.setAttribute("download","chat-shot.png"),typeof m.download>"u"&&m.setAttribute("target","_blank"),document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(B),o.loading=!1,s.success(x("chat.exportSuccess")),Promise.resolve()}catch{s.error(x("chat.exportFailed"))}finally{o.loading=!1}}})}function Te(o){a.value||f.warning({title:x("chat.deleteMessage"),content:x("chat.deleteMessageConfirm"),positiveText:x("common.yes"),negativeText:x("common.no"),onPositiveClick:()=>{u.deleteChatByUuid(+_,o)}})}function Se(){a.value||f.warning({title:x("chat.clearChat"),content:x("chat.clearChatConfirm"),positiveText:x("common.yes"),negativeText:x("common.no"),onPositiveClick:()=>{u.clearChatByUuid(+_)}})}function $e(o){y.value?o.key==="Enter"&&o.ctrlKey&&(o.preventDefault(),ie()):o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),ie())}function Be(){a.value&&(r.abort(),a.value=!1)}const Re=U(()=>O.value.startsWith("/")?pe.value.filter(o=>o.key.toLowerCase().includes(O.value.substring(1).toLowerCase())).map(o=>({label:o.value,value:o.value})):[]),Ae=o=>{for(const g of pe.value)if(g.value===o.label)return[g.key];return[]},Ie=U(()=>y.value?x("chat.placeholderMobile"):x("chat.placeholder")),Le=U(()=>a.value||!O.value||O.value.trim()===""),Ue=U(()=>{let o=["p-4"];return y.value&&(o=["sticky","left-0","bottom-0","right-0","p-2","pr-3","overflow-hidden"]),o});xe(()=>{var o;K(),v.value&&!y.value&&((o=v.value)==null||o.focus())}),ye(()=>{a.value&&r.abort()});function Ee(){ae.value=!1}function Oe(){return w.value.isLogin?!0:P()[0].data.length>=4?(console.log("login"),ae.value=!0,!1):!0}return(o,g)=>(p(),$("div",zt,[e(y)?(p(),j(bt,{key:0,"using-context":e(J),onExport:fe,onToggleUsingContext:e(z)},null,8,["using-context","onToggleUsingContext"])):q("",!0),n("main",Dt,[n("div",{id:"scrollRef",ref_key:"scrollRef",ref:N,class:"h-full overflow-hidden overflow-y-auto"},[n("div",{id:"image-wrapper",class:M(["w-full max-w-screen-xl m-auto dark:bg-[#101014]",[e(y)?"p-2":"p-4"]])},[e(I).length?(p(),$("div",Nt,[(p(!0),$(ee,null,Je(e(I),(S,B)=>(p(),j(e(gt),{key:B,"date-time":S.dateTime,text:S.text,inversion:S.inversion,error:S.error,loading:S.loading,onRegenerate:m=>be(B),onDelete:m=>Te(B)},null,8,["date-time","text","inversion","error","loading","onRegenerate","onDelete"]))),128)),n("div",jt,[a.value?(p(),j(e(te),{key:0,type:"warning",onClick:Be},{icon:C(()=>[c(e(E),{icon:"ri:stop-circle-line"})]),default:C(()=>[L(" Stop Responding ")]),_:1})):q("",!0)])])):(p(),$("div",Mt,[c(e(E),{icon:"ri:bubble-chart-fill",class:"mr-2 text-3xl"}),Pt]))],2)],512)]),n("footer",{class:M(e(Ue))},[n("div",Kt,[n("div",Zt,[c(e(Q),{onClick:Se},{default:C(()=>[n("span",Vt,[c(e(E),{icon:"ri:delete-bin-line"})])]),_:1}),e(y)?q("",!0):(p(),j(e(Q),{key:0,onClick:fe},{default:C(()=>[n("span",qt,[c(e(E),{icon:"ri:download-2-line"})])]),_:1})),e(y)?q("",!0):(p(),j(e(Q),{key:1,onClick:e(z)},{default:C(()=>[n("span",{class:M(["text-xl",{"text-[#154EC1]":e(J),"text-[#a8071a]":!e(J)}])},[c(e(E),{icon:"ri:chat-history-line"})],2)]),_:1},8,["onClick"])),c(e(Ge),{value:O.value,"onUpdate:value":g[1]||(g[1]=S=>O.value=S),options:e(Re),"render-label":Ae},{default:C(({handleInput:S,handleBlur:B,handleFocus:m})=>[c(e(F),{ref_key:"inputRef",ref:v,value:O.value,"onUpdate:value":g[0]||(g[0]=H=>O.value=H),style:{padding:"5px"},type:"textarea",placeholder:e(Ie),autosize:{minRows:1,maxRows:e(y)?4:8},onInput:S,onFocus:m,onBlur:B,onKeypress:$e},null,8,["value","placeholder","autosize","onInput","onFocus","onBlur"])]),_:1},8,["value","options"]),c(e(te),{type:"primary",style:{padding:"21px 12px","border-radius":"21px"},onClick:ie},{icon:C(()=>[n("span",Ht,[c(e(E),{icon:"ri:send-plane-fill"})])]),_:1}),c(Ot,{visible:ae.value,onCanClose:Ee},null,8,["visible"])])])],2)]))}});export{To as default};
