import{b as Oe}from"./vue-router-3dd1a1ae.js";import{s as De}from"./pinia-aa1e01f0.js";import{h as ze}from"./html2canvas-18c4afc9.js";import{u as ce,i as Pe,d as fe,_ as E,a as me,t as v,b as Me,c as se,e as Ee,f as xe,s as Ne,g as Ze,h as Ke,j as Ve,k as ve,l as ge}from"./index-cdab0087.js";import{d as oe,c as I,Q as h,R as U,O as e,V as D,F as ee,W as a,h as je,_ as qe,r as y,M as g,Y as j,U as ue,a0 as Fe,Z as q,S as C,n as ae,j as ye,e as R,b as He,A as Je,X as We}from"./@vue-e75d1031.js";import{q as he,f as le,H as Ge,I as Qe,h as V,l as te,n as Xe,e as Ye,J as et}from"./naive-ui-1791d9c8.js";const tt={key:1,class:"text-[28px] dark:text-white text-[#839bf1]"},ot=a("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32","aria-hidden":"true",width:"1em",height:"1em"},[a("path",{d:"M29.71,13.09A8.09,8.09,0,0,0,20.34,2.68a8.08,8.08,0,0,0-13.7,2.9A8.08,8.08,0,0,0,2.3,18.9,8,8,0,0,0,3,25.45a8.08,8.08,0,0,0,8.69,3.87,8,8,0,0,0,6,2.68,8.09,8.09,0,0,0,7.7-5.61,8,8,0,0,0,5.33-3.86A8.09,8.09,0,0,0,29.71,13.09Zm-12,16.82a6,6,0,0,1-3.84-1.39l.19-.11,6.37-3.68a1,1,0,0,0,.53-.91v-9l2.69,1.56a.08.08,0,0,1,.05.07v7.44A6,6,0,0,1,17.68,29.91ZM4.8,24.41a6,6,0,0,1-.71-4l.19.11,6.37,3.68a1,1,0,0,0,1,0l7.79-4.49V22.8a.09.09,0,0,1,0,.08L13,26.6A6,6,0,0,1,4.8,24.41ZM3.12,10.53A6,6,0,0,1,6.28,7.9v7.57a1,1,0,0,0,.51.9l7.75,4.47L11.85,22.4a.14.14,0,0,1-.09,0L5.32,18.68a6,6,0,0,1-2.2-8.18Zm22.13,5.14-7.78-4.52L20.16,9.6a.08.08,0,0,1,.09,0l6.44,3.72a6,6,0,0,1-.9,10.81V16.56A1.06,1.06,0,0,0,25.25,15.67Zm2.68-4-.19-.12-6.36-3.7a1,1,0,0,0-1.05,0l-7.78,4.49V9.2a.09.09,0,0,1,0-.09L19,5.4a6,6,0,0,1,8.91,6.21ZM11.08,17.15,8.38,15.6a.14.14,0,0,1-.05-.08V8.1a6,6,0,0,1,9.84-4.61L18,3.6,11.61,7.28a1,1,0,0,0-.53.91ZM12.54,14,16,12l3.47,2v4L16,20l-3.47-2Z",fill:"currentColor"})],-1),nt=[ot],at=oe({__name:"Avatar",props:{image:{type:Boolean}},setup(o){const l=ce(),r=I(()=>l.userInfo.avatar);return(f,m)=>o.image?(h(),U(ee,{key:0},[e(Pe)(e(r))&&e(r).length>0?(h(),D(e(he),{key:0,src:e(r),"fallback-src":e(fe)},null,8,["src","fallback-src"])):(h(),D(e(he),{key:1,round:"",src:e(fe)},null,8,["src"]))],64)):(h(),U("span",tt,nt))}}),st=()=>({iconRender:l=>{const{color:r,fontSize:f,icon:m}=l,s={};return r&&(s.color=r),f&&(s.fontSize=`${f}px`),m||window.console.warn("iconRender: icon is required"),()=>je(E,{icon:m,style:s})}});function lt(o){return new Promise((l,r)=>{try{const f=document.createElement("textarea");f.setAttribute("readonly","readonly"),f.value=o,document.body.appendChild(f),f.select(),document.execCommand("copy")&&document.execCommand("copy"),document.body.removeChild(f),l(o)}catch(f){r(f)}})}const rt={class:"flex flex-col"},it={class:"transition text-neutral-300 hover:text-neutral-800 dark:hover:text-neutral-200"},ct=oe({__name:"index",props:{dateTime:null,text:null,inversion:{type:Boolean},error:{type:Boolean},loading:{type:Boolean},showTooLong:{type:Boolean}},emits:["regenerate","delete"],setup(o,{emit:l}){const r=o,f=qe(()=>Me(()=>import("./Text-56704d51.js"),["js/Text-56704d51.js","js/markdown-it-e3a1182a.js","js/date-fns-9733c85e.js","js/uc.micro-740ead6f.js","js/mdurl-79eba04e.js","js/linkify-it-191b779c.js","js/punycode-3f09cc15.js","js/markdown-it-link-attributes-37292d98.js","js/highlight.js-f1ebc9d8.js","js/katex-eae73049.js","css/katex-df47a520.css","js/index-cdab0087.js","js/@vue-e75d1031.js","js/naive-ui-1791d9c8.js","js/vooks-b73419e1.js","js/evtd-b614532e.js","js/vdirs-b0483831.js","js/treemate-25c27bff.js","js/seemly-411025cc.js","js/vueuc-145bf272.js","js/@css-render-19d6fc9e.js","js/@juggle-41516555.js","js/css-render-d3958e6a.js","js/@emotion-8a8e73f6.js","js/lodash-es-cabc0acd.js","js/pinia-aa1e01f0.js","js/vue-router-3dd1a1ae.js","js/axios-760d4776.js","js/@vueuse-b960a1cb.js","js/vue-i18n-78e7aff6.js","js/@intlify-7347860c.js","js/@iconify-105318ea.js","css/index-602fe226.css","js/html2canvas-18c4afc9.js","css/Text-f0f3af04.css"])),{isMobile:m}=me(),{iconRender:s}=st(),i=le(),b=y(),k=y(r.inversion),x=y(),z=I(()=>{const $=[{label:v("chat.copy"),key:"copyText",icon:s({icon:"ri:file-copy-2-line"})},{label:v("common.delete"),key:"delete",icon:s({icon:"ri:delete-bin-line"})}];return r.inversion||$.unshift({label:k.value?v("chat.preview"):v("chat.showRawText"),key:"toggleRenderType",icon:s({icon:k.value?"ic:outline-code-off":"ic:outline-code"})}),$});function B($){switch($){case"copyText":O();return;case"toggleRenderType":k.value=!k.value;return;case"delete":l("delete")}}function A(){var $;($=x.value)==null||$.scrollIntoView(),l("regenerate")}async function O(){try{await lt(r.text||""),i.success("å¤åˆ¶æˆåŠŸ")}catch{i.error("å¤åˆ¶å¤±è´¥")}}const N=y(!0);function J(){N.value=!1}return($,F)=>(h(),U("div",{ref_key:"messageRef",ref:x,class:j(["flex w-full mb-6 overflow-hidden",[{"flex-row-reverse":o.inversion}]])},[a("div",{class:j(["flex items-center justify-center flex-shrink-0 h-8 overflow-hidden rounded-full basis-8",[o.inversion?"ml-2":"mr-2"]])},[g(at,{image:o.inversion},null,8,["image"])],2),a("div",{class:j(["overflow-hidden text-base",[o.inversion?"items-end":"items-start"]])},[a("p",{class:j(["text-xs text-[#b4bbc4]",[o.inversion?"text-right":"text-left"]])},ue(o.dateTime),3),a("div",{class:j(["flex items-end gap-1 mt-2",[o.inversion?"flex-row-reverse":"flex-row"]])},[(h(),D(Fe(e(f)),{ref_key:"textRef",ref:b,inversion:o.inversion,error:o.error,text:o.text,loading:o.loading,"show-too-long":o.showTooLong,"as-raw-text":k.value,class:j([o.inversion?"mySay":"gptSay"]),onLoad:J},null,40,["inversion","error","text","loading","show-too-long","as-raw-text","class"])),N.value?(h(),D(e(Ge),{key:0,height:"40px",round:""})):q("",!0),a("div",rt,[o.inversion?q("",!0):(h(),U("button",{key:0,class:"mb-2 transition text-neutral-300 hover:text-neutral-800 dark:hover:text-neutral-300",onClick:A},[g(e(E),{icon:"ri:restart-line"})])),g(e(Qe),{trigger:e(m)?"click":"hover",placement:o.inversion?"left":"right",options:e(z),onSelect:B},{default:C(()=>[a("button",it,[g(e(E),{icon:"ri:more-2-fill"})])]),_:1},8,["trigger","placement","options"])])],2)],2)],2))}});function ut(){const o=y(null);return{scrollRef:o,scrollToBottom:async()=>{await ae(),o.value&&(o.value.scrollTop=o.value.scrollHeight)},scrollToTop:async()=>{await ae(),o.value&&(o.value.scrollTop=0)},scrollToBottomIfAtBottom:async()=>{await ae(),o.value&&o.value.scrollHeight-o.value.scrollTop-o.value.clientHeight<=100&&(o.value.scrollTop=o.value.scrollHeight)}}}function dt(){const o=se();return{addChat:(i,b)=>{o.addChatByUuid(i,b)},updateChat:(i,b,k)=>{o.updateChatByUuid(i,b,k)},updateChatSome:(i,b,k)=>{o.updateChatSomeByUuid(i,b,k)},getChatByUuidAndIndex:(i,b)=>o.getChatByUuidAndIndex(i,b),getChatData:()=>o.getChatData()}}function pt(){const o=le(),l=se(),r=I(()=>l.usingContext);function f(){l.setUsingContext(!r.value),r.value?o.success(v("chat.turnOnContext")):o.warning(v("chat.turnOffContext"))}return{usingContext:r,toggleUsingContext:f}}const ft={class:"mheader sticky top-0 left-0 right-0 z-30 dark:border-neutral-800 bg-white/80 dark:bg-[#000000b8] backdrop-blur"},vt={class:"relative flex items-center justify-between min-w-0 overflow-hidden h-11"},gt={class:"flex items-center"},ht=oe({__name:"index",props:{usingContext:{type:Boolean}},setup(o){const l=Ee(),r=se(),f=I(()=>l.siderCollapsed),m=I(()=>r.getChatHistoryByCurrentActive);function s(){l.setSiderCollapsed(!f.value)}function i(){const b=document.querySelector("#scrollRef");b&&ae(()=>b.scrollTop=0)}return(b,k)=>{var x;return h(),U("header",ft,[a("div",vt,[a("div",gt,[a("button",{class:"flex items-center justify-center w-11 h-11",onClick:s},[e(f)?(h(),D(e(E),{key:0,class:"text-2xl",icon:"ri:align-justify"})):(h(),D(e(E),{key:1,class:"text-2xl",icon:"ri:align-right"}))])]),a("h1",{class:"flex-1 px-4 pr-6 overflow-hidden cursor-pointer select-none text-ellipsis whitespace-nowrap",onDblclick:i},ue(((x=e(m))==null?void 0:x.title)??""),33)])])}}});const mt={class:"p-10 bg-white rounded dark:bg-slate-800"},xt={class:"space-y-4"},yt={class:"space-y-2",style:{position:"relative"}},wt=a("div",{style:{background:"linear-gradient(139deg, rgb(254 50 50) 10.79%, rgb(27 153 239) 87.08%)",color:"rgb(255, 255, 255)",position:"absolute",right:"68px","font-size":"0.9rem",top:"3px",width:"49px",height:"25px","text-align":"center","line-height":"25px","border-radius":"11px"}}," å…è´¹ ",-1),_t={class:"text-2xl font-bold text-center text-slate-800 dark:text-neutral-200",style:{"font-size":"1.8rem"}},Ct=a("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[R(" ğŸ¤–ä»¥ç»§ç»­å…è´¹å’Œæˆ‘å¯¹è¯"),a("br")],-1),bt={style:{"text-align":"right","font-size":"0.8rem"}},kt=a("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[R(" ğŸ‰ä»…å‰©ä¸€æ­¥ï¼å³å°†å’Œæˆ‘ç»§ç»­å¯¹è¯~"),a("br")],-1),Tt=a("p",{class:"text-base text-center text-slate-500 dark:text-slate-500",style:{"font-size":"0.9rem","letter-spacing":"0.8px","font-weight":"600","margin-top":"4px"}},[R(" ğŸ‰ä»…å‰©ä¸€æ­¥ï¼å³å°†å’Œæˆ‘å¯¹è¯~"),a("br")],-1),St={style:{"text-align":"right","font-size":"0.8rem"}},$t=oe({__name:"Permission",props:{visible:{type:Boolean}},emits:["canClose"],setup(o,{emit:l}){const r=ce(),f=xe(),m=y("register_step1");ye(()=>f.modalType,(n,c)=>{n&&(m.value=n)},{immediate:!0});const s=le(),i=y(!1);function b(n){n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),J())}function k(n){n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),F())}const x=y(""),z=y(""),B=y(""),A=y(""),O=y(""),N=y("");async function J(){if(!x.value){s.error("è¯·è¾“å…¥email");return}if(!$(x.value)){s.error("emailæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é‡æ–°è¾“å…¥");return}try{i.value=!0;const n=await Ne(x.value);s.success("å·²å‘é‚®ç®±å‘é€éªŒè¯ç ï¼Œè¯·æ³¨æ„æŸ¥æ”¶~"),N.value=n.SCC,console.log(N.value),m.value="register_step2"}catch(n){s.error(n.message??"error")}finally{i.value=!1}}function $(n){const c=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return console.log(c.test(n)),c.test(n)}async function F(){if(!/^\d{6}$/.test(z.value)){s.error("é‚®ç®±éªŒè¯ç æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºå…­ä½æ•°å­—");return}if(B.value!==A.value){s.error("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€æ ·");return}if(!/^[A-Za-z0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]{6,15}$/.test(B.value)){s.error("å¯†ç æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä¸º6~15ä½æ•°å­—ã€å­—æ¯ã€å¸¸ç”¨ç¬¦å·çš„ä»»æ„ç»„åˆ");return}if(!/^[a-zA-Z0-9_\-.u4e00-\u9FA5]+$/.test(O.value)&&(O.value.length<2||O.value.length>20)){s.error("ç”¨æˆ·åæ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä¸º2~20ä¸ªå­—ç¬¦ä¹‹é—´çš„æ•°å­—ã€å­—æ¯ã€å¸¸ç”¨ç¬¦å·çš„ä»»æ„ç»„åˆ");return}try{i.value=!0,await Ze(x.value,z.value,O.value,B.value,N.value),s.success("æ³¨å†ŒæˆåŠŸï¼è‡ªåŠ¨ä¸ºæ‚¨ç™»é™†â€¦â€¦"),l("canClose",!0),r.updateUserInfo({name:O.value,isLogin:!0,vip:0})}catch(n){s.error(n.message??"error")}finally{i.value=!1}}function Q(n){m.value=n}const P=y(""),p=y(""),T=y("");async function W(){if(!P.value){s.error("è¯·è¾“å…¥ç”¨æˆ·åæˆ–Email");return}if($(P.value))T.value="email";else if(/^[a-zA-Z0-9_\-.u4e00-\u9FA5]+$/.test(P.value)||P.value.length<2||P.value.length>20)T.value="username";else{s.error("è´¦å·æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥ç”¨æˆ·åæˆ–Email");return}if(!/^[A-Za-z0-9!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]{6,15}$/.test(p.value)){s.error("å¯†ç æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä¸º6~15ä½æ•°å­—ã€å­—æ¯ã€å¸¸ç”¨ç¬¦å·çš„ä»»æ„ç»„åˆ");return}try{i.value=!0;const n=await Ke(P.value,p.value,T.value);s.success(`ç™»å½•æˆåŠŸï¼æ¬¢è¿${n.userName}`),l("canClose",!0),r.updateUserInfo({name:n.userName,isLogin:!0,vip:0})}catch(n){s.error(n.message??"error")}finally{i.value=!1}}function L(){l("canClose",!0)}return(n,c)=>(h(),D(e(Xe),{show:o.visible,"auto-focus":!1,style:{width:"90%","max-width":"380px"},onMaskClick:L},{default:C(()=>[a("div",mt,[a("div",xt,[a("header",yt,[wt,a("h2",_t,ue(m.value==="register_step1"||m.value==="register_step2"?"æ³¨å†Œ":"ç™»å½•"),1)]),m.value==="register_step1"?(h(),U(ee,{key:0},[Ct,g(e(V),{value:x.value,"onUpdate:value":c[0]||(c[0]=_=>x.value=_),type:"text",size:"large",autofocus:!1,placeholder:"è¯·è¾“å…¥ç”µå­é‚®ç®±,å¦‚xxx@xxx.xxx",onKeypress:b},{prefix:C(()=>[R(" Email ")]),_:1},8,["value"]),a("div",bt,[a("a",{style:{cursor:"pointer"},onClick:c[1]||(c[1]=_=>Q("login"))},"å·²æœ‰è´¦å·ï¼Œç«‹å³ç™»å½•->")]),g(e(te),{block:"",color:"#8a2be2",size:"large",loading:i.value,style:{"margin-top":"15px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:J},{default:C(()=>[R(" ä½¿ç”¨ç”µå­é‚®ç®±æ³¨å†Œ ")]),_:1},8,["loading"])],64)):q("",!0),m.value=="register_step2"?(h(),U(ee,{key:1},[kt,g(e(V),{value:z.value,"onUpdate:value":c[2]||(c[2]=_=>z.value=_),size:"large",placeholder:"Emailæ”¶åˆ°çš„6ä½æ•°å­—éªŒè¯ç ",onKeypress:k},{prefix:C(()=>[R(" éªŒè¯ç  ")]),_:1},8,["value"]),g(e(V),{value:O.value,"onUpdate:value":c[3]||(c[3]=_=>O.value=_),size:"large",placeholder:"è¯·è®¾ç½®ç”¨æˆ·å,å¯ä¸­æ–‡å¯è‹±æ–‡",onKeypress:k},{prefix:C(()=>[R(" ç”¨æˆ·å ")]),_:1},8,["value"]),g(e(V),{value:B.value,"onUpdate:value":c[4]||(c[4]=_=>B.value=_),size:"large",type:"password",placeholder:"è¯·è®¾ç½®å¯†ç ",onKeypress:k},{prefix:C(()=>[R(" å¯†ç  ")]),_:1},8,["value"]),g(e(V),{value:A.value,"onUpdate:value":c[5]||(c[5]=_=>A.value=_),size:"large",type:"password",placeholder:"è¯·å†æ¬¡è¾“å…¥å¯†ç ",onKeypress:k},{prefix:C(()=>[R(" å¯†ç  ")]),_:1},8,["value"]),g(e(te),{block:"",color:"#8a2be2",size:"large",loading:i.value,style:{"margin-top":"20px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:F},{default:C(()=>[R(" æ³¨å†Œå¹¶ç™»å½• ")]),_:1},8,["loading"])],64)):q("",!0),m.value==="login"?(h(),U(ee,{key:2},[Tt,g(e(V),{value:P.value,"onUpdate:value":c[6]||(c[6]=_=>P.value=_),size:"large",placeholder:"è¯·è¾“å…¥ç”¨æˆ·åæˆ–Email",onKeypress:W},{prefix:C(()=>[R(" è´¦å· ")]),_:1},8,["value"]),g(e(V),{value:p.value,"onUpdate:value":c[7]||(c[7]=_=>p.value=_),size:"large",type:"password",placeholder:"è¯·è¾“å…¥å¯†ç ",onKeypress:W},{prefix:C(()=>[R(" å¯†ç  ")]),_:1},8,["value"]),a("div",St,[a("a",{style:{cursor:"pointer"},onClick:c[8]||(c[8]=_=>Q("register_step1"))},"æ²¡æœ‰è´¦å·ï¼Œç«‹å³æ³¨å†Œ->")]),g(e(te),{block:"",color:"#8a2be2",size:"large",loading:i.value,style:{"margin-top":"20px",background:"linear-gradient(327deg, rgb(97 115 255) 10.79%, rgb(239 27 225) 87.08%)",opacity:"1"},onClick:W},{default:C(()=>[R(" ç™»å½• ")]),_:1},8,["loading"])],64)):q("",!0)])])]),_:1},8,["show"]))}});const At={class:"flex flex-col w-full h-full"},Rt={class:"flex-1 overflow-hidden"},Bt={key:0,class:"flex items-center justify-center mt-4 text-center text-neutral-300"},Lt=a("span",null,"Aha~",-1),It={key:1},Ut={class:"sticky bottom-0 left-0 flex justify-center"},Ot={class:"w-full max-w-screen-xl m-auto"},Dt={class:"flex items-center justify-between space-x-2"},zt={class:"text-xl text-[#4f555e] dark:text-white"},Pt={class:"text-xl text-[#4f555e] dark:text-white"},Mt={class:"text-white"},Et=oe({__name:"index",setup(o){let l=new AbortController;const r=!1,f=Oe(),m=Ye(),s=le(),i=se(),b=ce(),k=I(()=>b.userInfo),{isMobile:x}=me(),{addChat:z,updateChat:B,updateChatSome:A,getChatByUuidAndIndex:O,getChatData:N}=dt(),{scrollRef:J,scrollToBottom:$,scrollToBottomIfAtBottom:F}=ut(),{usingContext:Q,toggleUsingContext:P}=pt(),{uuid:p}=f.params,T=I(()=>i.getChatByUuid(+p)),W=I(()=>T.value.filter(t=>!t.inversion&&!!t.conversationOptions)),L=y(""),n=y(!1),c=y(null),_=xe(),ne=y(!1);ye(()=>_.showModal,(t,u)=>{t&&!u&&(ne.value=!0,_.updateSetting({showModal:!1,modalType:"login"}))},{immediate:!0});const we=Ve(),{promptList:de}=De(we);T.value.forEach((t,u)=>{t.loading&&A(+p,u,{loading:!1})});function re(){Be.value||Ue()&&_e()}async function _e(){var S;let t=L.value;if(n.value||!t||t.trim()==="")return;l=new AbortController,z(+p,{dateTime:new Date().toLocaleString(),text:t,inversion:!0,error:!1,conversationOptions:null,requestOptions:{prompt:t,options:null}}),$(),n.value=!0,L.value="";let u={};const w=(S=W.value[W.value.length-1])==null?void 0:S.conversationOptions;w&&Q.value&&(u={...w}),z(+p,{dateTime:new Date().toLocaleString(),text:"",loading:!0,inversion:!1,error:!1,conversationOptions:null,requestOptions:{prompt:t,options:{...u}}}),$();try{let d="";await(async()=>{let M;await ve({prompt:t,options:u,signal:l.signal,onDownloadProgress:({event:ie})=>{const G=ie.target,{responseText:H}=G,X=H.lastIndexOf(`
`,H.length-2);let K=H;X!==-1&&(K=H.substring(X));try{const Y=JSON.parse(K);B(+p,T.value.length-1,{dateTime:new Date().toLocaleString(),text:d+(Y.text??""),inversion:!1,error:!1,loading:!0,conversationOptions:{conversationId:Y.conversationId,parentMessageId:Y.id},requestOptions:{prompt:t,options:{...u}}}),A(+p,T.value.length-1,{showTooLong:!1}),clearTimeout(M),M=setTimeout(()=>{A(+p,T.value.length-1,{showTooLong:!0}),console.log("long")},2500),r&&Y.detail.choices[0].finish_reason,F()}catch{}}}),A(+p,T.value.length-1,{loading:!1})})()}catch(d){const Z=(d==null?void 0:d.message)??v("common.wrong");if(d.message==="canceled"){A(+p,T.value.length-1,{loading:!1}),F();return}const M=O(+p,T.value.length-1);if(M!=null&&M.text&&M.text!==""){A(+p,T.value.length-1,{text:`${M.text}
[${Z}]`,error:!1,loading:!1});return}B(+p,T.value.length-1,{dateTime:new Date().toLocaleString(),text:Z,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:t,options:{...u}}}),F()}finally{n.value=!1}}async function Ce(t){if(n.value)return;l=new AbortController;const{requestOptions:u}=T.value[t];let w=(u==null?void 0:u.prompt)??"",S={};u.options&&(S={...u.options}),n.value=!0,B(+p,t,{dateTime:new Date().toLocaleString(),text:"",inversion:!1,error:!1,loading:!0,conversationOptions:null,requestOptions:{prompt:w,options:{...S}}});try{let d="";await(async()=>{await ve({prompt:w,options:S,signal:l.signal,onDownloadProgress:({event:M})=>{const ie=M.target,{responseText:G}=ie,H=G.lastIndexOf(`
`,G.length-2);let X=G;H!==-1&&(X=G.substring(H));try{const K=JSON.parse(X);B(+p,t,{dateTime:new Date().toLocaleString(),text:d+(K.text??""),inversion:!1,error:!1,loading:!0,conversationOptions:{conversationId:K.conversationId,parentMessageId:K.id},requestOptions:{prompt:w,options:{...S}}}),r&&K.detail.choices[0].finish_reason}catch{}}}),A(+p,t,{loading:!1})})()}catch(d){if(d.message==="canceled"){A(+p,t,{loading:!1});return}const Z=(d==null?void 0:d.message)??v("common.wrong");B(+p,t,{dateTime:new Date().toLocaleString(),text:Z,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:w,options:{...S}}})}finally{n.value=!1}}function pe(){if(n.value)return;const t=m.warning({title:v("chat.exportImage"),content:v("chat.exportImageConfirm"),positiveText:v("common.yes"),negativeText:v("common.no"),onPositiveClick:async()=>{try{t.loading=!0;const u=document.getElementById("image-wrapper"),S=(await ze(u,{useCORS:!0})).toDataURL("image/png"),d=document.createElement("a");d.style.display="none",d.href=S,d.setAttribute("download","chat-shot.png"),typeof d.download>"u"&&d.setAttribute("target","_blank"),document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(S),t.loading=!1,s.success(v("chat.exportSuccess")),Promise.resolve()}catch{s.error(v("chat.exportFailed"))}finally{t.loading=!1}}})}function be(t){n.value||m.warning({title:v("chat.deleteMessage"),content:v("chat.deleteMessageConfirm"),positiveText:v("common.yes"),negativeText:v("common.no"),onPositiveClick:()=>{i.deleteChatByUuid(+p,t)}})}function ke(){n.value||m.warning({title:v("chat.clearChat"),content:v("chat.clearChatConfirm"),positiveText:v("common.yes"),negativeText:v("common.no"),onPositiveClick:()=>{i.clearChatByUuid(+p)}})}function Te(t){x.value?t.key==="Enter"&&t.ctrlKey&&(t.preventDefault(),re()):t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),re())}function Se(){n.value&&(l.abort(),n.value=!1)}const $e=I(()=>L.value.startsWith("/")?de.value.filter(t=>t.key.toLowerCase().includes(L.value.substring(1).toLowerCase())).map(t=>({label:t.value,value:t.value})):[]),Ae=t=>{for(const u of de.value)if(u.value===t.label)return[u.key];return[]},Re=I(()=>x.value?v("chat.placeholderMobile"):v("chat.placeholder")),Be=I(()=>n.value||!L.value||L.value.trim()===""),Le=I(()=>{let t=["p-4"];return x.value&&(t=["sticky","left-0","bottom-0","right-0","p-2","pr-3","overflow-hidden"]),t});He(()=>{var t;$(),c.value&&!x.value&&((t=c.value)==null||t.focus()),setTimeout(()=>{N()[0].data.length==0&&z(+p,{dateTime:new Date().toLocaleString(),text:"å¾ˆé«˜å…´å†æ¬¡è§åˆ°ä½ ï¼Œæˆ‘æ˜¯çŸ¥æ½®GPTï¼Œæœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦è§£å†³å—ï¼Ÿ",inversion:!1,error:!1,conversationOptions:null,requestOptions:{prompt:"eeeeeeeee",options:null}})},100)}),Je(()=>{n.value&&l.abort()});function Ie(){ne.value=!1}function Ue(){return k.value.isLogin?!0:N()[0].data.length>=4?(console.log("login"),ne.value=!0,!1):!0}return(t,u)=>(h(),U("div",At,[e(x)?(h(),D(ht,{key:0,"using-context":e(Q),onExport:pe,onToggleUsingContext:e(P)},null,8,["using-context","onToggleUsingContext"])):q("",!0),a("main",Rt,[a("div",{id:"scrollRef",ref_key:"scrollRef",ref:J,class:"h-full overflow-hidden overflow-y-auto"},[a("div",{id:"image-wrapper",class:j(["w-full max-w-screen-xl m-auto",[e(x)?"p-2":"p-4"]])},[e(T).length?(h(),U("div",It,[(h(!0),U(ee,null,We(e(T),(w,S)=>(h(),D(e(ct),{key:S,"date-time":w.dateTime,text:w.text,inversion:w.inversion,error:w.error,loading:w.loading,"show-too-long":w.showTooLong,onRegenerate:d=>Ce(S),onDelete:d=>be(S)},null,8,["date-time","text","inversion","error","loading","show-too-long","onRegenerate","onDelete"]))),128)),a("div",Ut,[n.value?(h(),D(e(te),{key:0,type:"warning",onClick:Se},{icon:C(()=>[g(e(E),{icon:"ri:stop-circle-line"})]),default:C(()=>[R(" Stop Responding ")]),_:1})):q("",!0)])])):(h(),U("div",Bt,[g(e(E),{icon:"ri:bubble-chart-fill",class:"mr-2 text-3xl"}),Lt]))],2)],512)]),a("footer",{class:j(e(Le))},[a("div",Ot,[a("div",Dt,[g(e(ge),{onClick:ke},{default:C(()=>[a("span",zt,[g(e(E),{icon:"carbon:clean"})])]),_:1}),e(x)?q("",!0):(h(),D(e(ge),{key:0,onClick:pe},{default:C(()=>[a("span",Pt,[g(e(E),{icon:"ri:download-2-line"})])]),_:1})),g(e(et),{value:L.value,"onUpdate:value":u[1]||(u[1]=w=>L.value=w),options:e($e),"render-label":Ae},{default:C(({handleInput:w,handleBlur:S,handleFocus:d})=>[g(e(V),{ref_key:"inputRef",ref:c,value:L.value,"onUpdate:value":u[0]||(u[0]=Z=>L.value=Z),style:{padding:"5px"},type:"textarea",placeholder:e(Re),autosize:{minRows:1,maxRows:e(x)?4:8},onInput:w,onFocus:d,onBlur:S,onKeypress:Te},null,8,["value","placeholder","autosize","onInput","onFocus","onBlur"])]),_:1},8,["value","options"]),g(e(te),{id:"sendButton",type:"primary",style:{padding:"21px 12px","border-radius":"21px"},onClick:re},{icon:C(()=>[a("span",Mt,[g(e(E),{icon:"ri:send-plane-fill"})])]),_:1}),g($t,{visible:ne.value,onCanClose:Ie},null,8,["visible"])])])],2)]))}});const Ft=Object.freeze(Object.defineProperty({__proto__:null,default:Et},Symbol.toStringTag,{value:"Module"}));export{lt as c,Ft as i};
